// handles interfacing with omggif-worker.js
function RndNum(n){
var rnd="";
for(var i=0;i<n;i++)
rnd+=Math.floor(Math.random()*10);
return rnd;
}
function convertCanvasToImage(canvas) { 
		//新Image对象，可以理解为DOM 
		var image = new Image(); 
		// canvas.toDataURL 返回的是一串Base64编码的URL，当然,浏览器自己肯定支持 
		// 指定格式 PNG 
		image.src = canvas.toDataURL("image/png"); 
		return image; 
} 
var MFAnimatedGIF = function(opts) {
    var encoder;

    var _rotate = function(image, rotation) {
        var canvas = document.createElement("canvas");

        canvas.width = image.width;
        canvas.height = image.height;

        var ctx = canvas.getContext('2d');
        ctx.translate(image.width/2, image.height/2);
        ctx.rotate(rotation * Math.PI / 180.0);
        ctx.drawImage(image, -image.width/2, -image.height/2, image.width, image.height);
        ctx.rotate(rotation * Math.PI / 180.0);
        ctx.translate(-image.width/2, -image.height/2);

        return canvas;
    };

    var _initialize = function(opts) {

        var canvas = document.createElement("canvas");
        var context = canvas.getContext('2d');

        canvas.width  = opts.width;
        canvas.height = opts.height;

        var frames = [];
        for(var i=0; i<opts.images.length; i++) {
            //var animframe = (opts.rotations[i] === 0) ? opts.images[i] : _rotate(opts.images[i], opts.rotations[i]);
            //context.clearRect(0, 0, canvas.width, canvas.height);
           //  context.drawImage(animframe, 0, 0, animframe.width, animframe.height, 0, 0, canvas.width, canvas.height);
				
           // var imageData = opts.images[i];
			//var newimage = convertCanvasToImage(imageCanvas);
			//context.clearRect(0, 0, canvas.width, canvas.height);
			//context.drawImage(newimage, 0, 0, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
			var imagecanvas = opts.images[i];
			var ctx = imagecanvas.getContext("2d");
			var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
			//var imageData = imagecanvas.toDataURL("image/png");
			//var imageData = context.getImageData(0, 0, canvas.width, canvas.height)
			//var imagedatastr  = imageData.data.buffer;
			//console.log(imagedatastr);
            frames.push(imageData);
        }

        var gifWorker = new Worker("lib/mgif/libraries/omggif-worker.js");

        gifWorker.addEventListener('message', function (e) {
            if (e.data.type === "progress") {
                // Percent done, 0.0-0.1
                opts.progress(e.data.data);
            } else if(e.data.type === "progressG"){
				 opts.progressG(e.data.data);
			}else if (e.data.type === "gif") {
                var info = e.data;
                //info.binaryURL = _binaryURL( e.data.data );
                info.rawDataURL = _rawDataURL( e.data.data );
                info.dataURL = _dataURL( info.rawDataURL );
                opts.done(info);
            }
        }, false);
        gifWorker.addEventListener('error', function (e) {
            opts.error(e);
            gifWorker.terminate();
        }, false);
		
		for(var i=0;i<frames.length;i++){
			
			gifWorker.postMessage({
				frame: frames[i],
				fun: 'addframe'
       		});
			
		}
		
        gifWorker.postMessage({
				delay: opts.delay,
				disposal: opts.disposal,
				alpha: opts.alpha,
				width: opts.width,
				height: opts.height,
				matte: [255, 255, 255],
				transparent: [255, 255, 255],
				gloabpalette:opts.gloabpalette,//true false;
				fun:'go'
       	});
	
    };

    var _rawDataURL = function(data) {
        return $.base64.encode(data);
    };

    var _dataURL = function(rawData) {
        return 'data:image/gif;base64,' + rawData;
    };

    var _binaryURL = function(data) {
        window.URL = window.URL || window.webkitURL;
        var blob = new Blob([data], {type: 'image/gif'});
        return window.URL.createObjectURL(blob);
    };

    _initialize(opts);

};
